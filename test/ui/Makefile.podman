# Makefile for ARM UI build in Podman container

.PHONY: all clean podman-build

CONTAINER_IMAGE = localhost/logue-sdk-dev-env:latest
CONTAINER_NAME = drumlogue-ui-builder

# Source files
SOURCES = ui_main.c pattern.c
INCLUDES = -I../qemu-arm
LIBS = -lncurses -ldl -lm -pthread

# Compiler flags
CC = arm-linux-gnueabihf-gcc
CFLAGS = -std=c11 -O2 -Wall -Wextra -g $(INCLUDES)

# Output
TARGET = ui_player_arm
OBJECTS = $(SOURCES:.c=.o)

# Unit host objects from qemu-arm
UNIT_HOST_OBJS = ../qemu-arm/unit_host.o ../qemu-arm/wav_file.o ../qemu-arm/sdk_stubs.o

all: podman-build

podman-build:
	@echo "=== Building ARM UI in SDK container ==="
	podman run --rm \
		-v $(CURDIR)/../..:/repo:ro \
		-v $(CURDIR)/..:/workspace \
		-w /workspace/ui \
		$(CONTAINER_IMAGE) \
		/bin/bash -c " \
			apt-get update -qq && apt-get install -y -qq libncurses-dev:armhf > /dev/null 2>&1 && \
			echo 'Compiling unit_host objects...' && \
			cd ../qemu-arm && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -c unit_host.c -o unit_host.o && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -c wav_file.c -o wav_file.o && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -c sdk_stubs.c -o sdk_stubs.o && \
			cd ../ui && \
			echo 'Compiling UI sources...' && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -I../qemu-arm -c pattern.c -o pattern.o && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -I../qemu-arm -c ui_main.c -o ui_main.o && \
			echo 'Linking ARM executable...' && \
			arm-linux-gnueabihf-gcc -std=c11 -O2 -Wall -Wextra -g -I../qemu-arm -o $(TARGET) ui_main.o pattern.o ../qemu-arm/unit_host.o ../qemu-arm/wav_file.o ../qemu-arm/sdk_stubs.o $(LIBS) && \
			echo 'Build complete: $(TARGET)' && \
			file $(TARGET) && \
			ls -lh $(TARGET) \
		"
	@echo "=== Verifying build ==="
	@file $(TARGET)
	@ls -lh $(TARGET)

clean:
	rm -f $(TARGET) *.o ../qemu-arm/*.o
